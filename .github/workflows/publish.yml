name: Publish Docker Image

#:#['.']:>----------------------------------------------------------------------
#:#['.']:> Â¡Este workflow es nuestro lanzacohetes! ðŸš€
#:#['.']:> Se encarga de construir y publicar la imagen Docker en GitHub Packages
#:#['.']:> cuando creamos un tag. Â¡Directo al espacio! ðŸŒŒ
#:#['.']:>----------------------------------------------------------------------
on:
  push:
    tags:
      - 'DISABLED_*.*.*' # ðŸ‘ˆ Â¡Cambia esto para activar quita: DISABLED_!
#:#['.']:>----------------------------------------------------------------------
#:#['.']:> Â¡Ejemplos de triggers! ðŸš€
#:#['.']:>
#:#['.']:> - Para ejecutar en cada push a la rama "main":
#:#['.']:>   branches: [ main ]
#:#['.']:>
#:#['.']:> - Para ejecutar en cada pull request a la rama "develop":
#:#['.']:>   pull_request:
#:#['.']:>     branches: [ develop ]
#:#['.']:>
#:#['.']:> - Para ejecutar manualmente (workflow_dispatch):
#:#['.']:>   workflow_dispatch:
#:#['.']:>
#:#['.']:> - Para ejecutar cada dÃ­a a las 03:00 AM UTC:
#:#['.']:>   schedule:
#:#['.']:>     - cron: '0 3 * * *'
#:#['.']:>
#:#['.']:> - Para ejecutar en cada push de tags:
#:#['.']:>   tags:
#:#['.']:>     - '*'
#:#['.']:>----------------------------------------------------------------------


#:#['.']:>----------------------------------------------------------------------
#:#['.']:> Â¡Creamos el trabajo "publish"! ðŸ­
#:#['.']:> Este trabajo es el que se encarga de construir y publicar la imagen.
#:#['.']:> Â¡Es el corazÃ³n de la automatizaciÃ³n! â¤ï¸
#:#['.']:>----------------------------------------------------------------------
jobs:
  publish:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest

    #:#['.']:>------------------------------------------------------------------
    #:#['.']:> Â¡Damos permisos para publicar! ðŸ”‘
    #:#['.']:> Necesitamos permisos para leer el cÃ³digo y escribir en GitHub
    #:#['.']:> Packages. Â¡Con permiso, por favor! ðŸ™
    #:#['.']:>------------------------------------------------------------------
    permissions:
      contents: read
      packages: write

    #:#['.']:>------------------------------------------------------------------
    #:#['.']:> Â¡AquÃ­ vienen los pasos! ðŸš¶
    #:#['.']:> Cada paso es una tarea especÃ­fica que se ejecuta en el workflow.
    #:#['.']:> Â¡Vamos a ver quÃ© hacen! ðŸ‘€
    #:#['.']:>------------------------------------------------------------------
    steps:
      #:#['.']:>----------------------------------------------------------------
      #:#['.']:> Â¡Clonamos el cÃ³digo! ðŸ‘¯
      #:#['.']:> Necesitamos una copia del cÃ³digo para poder construir la imagen.
      #:#['.']:> Â¡Sin cÃ³digo no hay imagen! ðŸ–¼ï¸
      #:#['.']:>----------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      #:#['.']:>----------------------------------------------------------------
      #:#['.']:> Â¡Autenticamos con GitHub Packages! ðŸ”
      #:#['.']:> Necesitamos autenticarnos para poder publicar la imagen.
      #:#['.']:> Â¡Usuario y contraseÃ±a, por favor! ðŸ“
      #:#['.']:>----------------------------------------------------------------
      - name: Log in to GitHub Docker Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      #:#['.']:>----------------------------------------------------------------
      #:#['.']:> Â¡Construimos la imagen Docker! ðŸ—ï¸
      #:#['.']:> Usamos el Dockerfile para construir la imagen.
      #:#['.']:> Â¡Ladrillo a ladrillo! ðŸ§±
      #:#['.']:>----------------------------------------------------------------
      - name: Build Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/markitos-svc-boilerplates-grpc:${{ github.ref_name }} .
        env:
          VERSION: ${{ github.ref_name }}

      #:#['.']:>----------------------------------------------------------------
      #:#['.']:> Â¡Publicamos la imagen en GitHub Packages! ðŸ“¤
      #:#['.']:> Subimos la imagen al registro de contenedores de GitHub.
      #:#['.']:> Â¡A volar! ðŸš€
      #:#['.']:>----------------------------------------------------------------
      - name: Push Docker image
        run: docker push ghcr.io/${{ github.repository_owner }}/markitos-svc-boilerplates-grpc:${{ github.ref_name }}

      #:#['.']:>----------------------------------------------------------------
      #:#['.']:> Â¡Verificamos la imagen publicada! âœ…
      #:#['.']:> Nos aseguramos de que la imagen se ha publicado correctamente.
      #:#['.']:> Â¡MisiÃ³n cumplida! ðŸŽ‰
      #:#['.']:>----------------------------------------------------------------
      - name: Verify published image
        run: |
          echo "Docker image published successfully:"
          echo "ghcr.io/${{ github.repository_owner }}/markitos-svc-boilerplates-grpc:${{ github.ref_name }}"